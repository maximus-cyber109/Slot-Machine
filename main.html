<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB DAYS ARCADE - SPIN THE WHEEL</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;600;700;800&family=Bungee&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1200px;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #1a0033 0%, #000000 70%), linear-gradient(45deg, rgba(25, 25, 112, 0.3) 0%, rgba(75, 0, 130, 0.2) 100%);
            animation: backgroundShift 10s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% { filter: brightness(1) hue-rotate(0deg); }
            50% { filter: brightness(1.1) hue-rotate(15deg); }
        }
        
        /* Email popup with Orbitron font */
        .email-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }
        
        .email-popup.hidden {
            display: none;
        }
        
        .email-popup-content {
            background: linear-gradient(145deg, #ffd700 0%, #ffed4e 100%);
            padding: 40px;
            border-radius: 20px;
            border: 6px solid #8b4513;
            text-align: center;
            max-width: 450px;
            width: 90%;
            color: #8b4513;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.8);
            font-family: 'Orbitron', monospace !important;
        }
        
        .email-popup-content h2 {
            font-family: 'Orbitron', monospace !important;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .email-popup-content p {
            font-family: 'Orbitron', monospace !important;
            font-weight: 400;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .email-popup-content input {
            font-family: 'Orbitron', monospace !important;
            font-size: 12px;
            padding: 15px;
            width: 100%;
            border: 3px solid #8b4513;
            border-radius: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.9);
            color: #8b4513;
        }
        
        .popup-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .popup-buttons button {
            min-width: 150px;
            padding: 15px 25px;
            background: #8b4513;
            color: #ffd700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Orbitron', monospace !important;
            font-size: 10px;
            font-weight: 600;
        }
        
        /* ✅ FIXED: Custom Modal with bigger text and no OK button for order used */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #ffd700 0%, #ffed4e 100%);
            padding: 40px; /* ✅ Increased padding */
            border-radius: 15px;
            border: 4px solid #8b4513;
            text-align: center;
            max-width: 500px; /* ✅ Increased max-width */
            width: 90%;
            color: #8b4513;
            font-family: 'Orbitron', monospace !important;
            font-size: 14px !important; /* ✅ BIGGER TEXT */
            line-height: 1.8; /* ✅ Better line height */
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.8);
        }
        
        .modal-close {
            background: #8b4513;
            color: #ffd700;
            border: none;
            padding: 15px 30px; /* ✅ Bigger button */
            border-radius: 10px;
            font-size: 12px !important; /* ✅ Bigger button text */
            font-family: 'Orbitron', monospace !important;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* ✅ UPDATED: Order Again button styling */
        .order-again-btn {
            background: linear-gradient(145deg, #ff4b5c 0%, #ff0000 100%) !important;
            color: white !important;
            border: none !important;
            padding: 15px 30px !important; /* ✅ Bigger button */
            border-radius: 12px !important;
            font-size: 12px !important; /* ✅ Bigger button text */
            font-family: 'Orbitron', monospace !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            text-transform: uppercase !important;
            margin: 15px !important; /* ✅ More margin */
            box-shadow: 0 4px 15px rgba(255, 75, 92, 0.4) !important;
        }
        
        .order-again-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 75, 92, 0.6) !important;
        }
        
        /* Audio Control */
        .audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #ffd700 0%, #ffb300 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .return-home {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
            z-index: 1001;
        }
        
        /* Slot Machine */
        .slot-machine-container {
            position: relative;
            width: 400px;
            height: 600px;
            transform-style: preserve-3d;
            filter: drop-shadow(0 30px 60px rgba(0,0,0,0.8));
            animation: machineFloat 6s ease-in-out infinite;
        }
        
        @keyframes machineFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .slot-machine-bg {
            width: 100%;
            height: 100%;
            background-image: url('https://email-editor-resources.s3.amazonaws.com/images/82618240/stw-sep25/Slot-machine.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
        }
        
        .header-text {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #333;
            background: rgba(255,255,255,0.95);
            padding: 12px 20px;
            border-radius: 18px;
            border: 3px solid rgba(255,181,0,0.9);
            backdrop-filter: blur(15px);
            z-index: 10;
            width: 300px;
            font-family: 'Orbitron', monospace;
        }
        
        /* Reels positioning */
        .reels-overlay {
            position: absolute;
            top: 280px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 100px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 5;
        }
        
        .reel-window {
            width: 58px;
            height: 75px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: transparent;
            box-shadow: 0 0 20px rgba(255,215,0,0.3);
            animation: reelGlow 4s ease-in-out infinite alternate;
        }
        
        @keyframes reelGlow {
            0% { box-shadow: 0 0 20px rgba(255,215,0,0.3); }
            100% { box-shadow: 0 0 35px rgba(255,215,0,0.6); }
        }
        
        .reel-strip {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .reel-strip.spinning {
            animation: reelSpin 0.05s linear infinite;
        }
        
        @keyframes reelSpin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-75px); }
        }
        
        .symbol {
            width: 58px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border-radius: 6px;
            margin-bottom: 1px;
        }
        
        .symbol img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: brightness(1.2) contrast(1.3) drop-shadow(0 2px 6px rgba(0,0,0,0.4));
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .symbol.winning img {
            filter: brightness(1.6) contrast(1.7) drop-shadow(0 0 25px #ffd700);
            transform: scale(1.2);
            animation: symbolWin 0.3s ease-in-out infinite alternate;
        }
        
        @keyframes symbolWin {
            0% { transform: scale(1.2); }
            100% { transform: scale(1.25); }
        }
        
        /* Spin button positioning */
        .spin-button-container {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .spin-button {
            width: 160px;
            height: 42px;
            background: linear-gradient(145deg, #ffd700 0%, #ffed4e 30%, #b8860b 100%);
            border: none;
            border-radius: 21px;
            color: #333;
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(255,181,0,0.6), 0 0 50px rgba(255,215,0,0.4);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 3px solid rgba(255,255,255,0.4);
            animation: buttonPulse 2s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes buttonPulse {
            0%, 100% { 
                box-shadow: 0 10px 25px rgba(255,181,0,0.6), 0 0 50px rgba(255,215,0,0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 15px 35px rgba(255,181,0,0.8), 0 0 80px rgba(255,215,0,0.7);
                transform: scale(1.02);
            }
        }
        
        .spin-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 20px 50px rgba(255,181,0,0.8), 0 0 100px rgba(255,215,0,1);
        }
        
        .spin-button.spinning-state {
            background: linear-gradient(145deg, #ff6b6b 0%, #ee5a52 100%) !important;
            color: white !important;
            cursor: not-allowed !important;
            opacity: 0.8 !important;
            transform: none !important;
            animation: spinningPulse 1s ease-in-out infinite alternate !important;
        }
        
        @keyframes spinningPulse {
            0% { opacity: 0.7; }
            100% { opacity: 0.9; }
        }
        
        .spin-button:disabled {
            pointer-events: none !important;
            user-select: none !important;
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(145deg, #888 0%, #666 100%);
            animation: none;
        }
        
        .spin-button.prize-won {
            background: linear-gradient(145deg, #4caf50 0%, #45a049 100%) !important;
            color: white !important;
            animation: successGlow 0.5s ease-in-out infinite alternate !important;
        }
        
        @keyframes successGlow {
            0% { box-shadow: 0 10px 25px rgba(76, 175, 80, 0.6), 0 0 50px rgba(76, 175, 80, 0.4); }
            100% { box-shadow: 0 15px 35px rgba(76, 175, 80, 0.8), 0 0 80px rgba(76, 175, 80, 0.7); }
        }
        
        /* Status Display */
        .status-overlay {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .spins-left {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 8px 15px;
            border-radius: 15px;
            border: 3px solid rgba(255,181,0,0.9);
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
            font-size: 8px;
            font-family: 'Press Start 2P', monospace;
            backdrop-filter: blur(15px);
        }
        
        /* ✅ FIXED: Winner Card with proper mobile sizing */
        .golden-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 380px;
            height: auto; /* ✅ CHANGED: Auto height instead of fixed */
            max-height: 90vh; /* ✅ ADDED: Max height constraint for mobile */
            background: #000000 !important;
            border-radius: 25px;
            border: 8px solid #FFD700;
            box-shadow: 0 0 80px rgba(255,215,0,1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            padding: 20px 15px 20px 15px; /* ✅ ADJUSTED: Better padding */
            overflow-y: auto; /* ✅ ADDED: Allow scrolling if content is too tall */
        }
        
        .golden-card.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            animation: cardGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes cardGlow {
            0% { box-shadow: 0 0 80px rgba(255,215,0,1); }
            100% { box-shadow: 0 0 120px rgba(255,215,0,1); }
        }
        
        .eureka-header {
            font-size: 22px !important; /* ✅ ADJUSTED: Slightly smaller for mobile */
            font-family: 'Orbitron', monospace !important;
            font-weight: 700;
            color: #FFFFFF !important;
            margin-bottom: 15px; /* ✅ INCREASED: More margin */
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.4), 0 0 10px rgba(255, 255, 255, 0.2) !important;
            animation: headerShimmer 2s ease-in-out infinite alternate;
            line-height: 1.2; /* ✅ ADJUSTED: Better line height */
            white-space: nowrap;
            max-width: 100%;
            overflow: visible;
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        @keyframes headerShimmer {
            0% { text-shadow: 0 0 6px rgba(255, 255, 255, 0.4), 0 0 10px rgba(255, 255, 255, 0.2); }
            100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.5), 0 0 14px rgba(255, 255, 255, 0.3); }
        }
        
        .prize-image {
            max-width: 90% !important; /* ✅ REDUCED: Slightly smaller for mobile */
            max-height: 140px !important; /* ✅ REDUCED: Smaller height for mobile */
            width: auto !important;
            height: auto !important;
            margin: 15px auto; /* ✅ INCREASED: More margin */
            border-radius: 15px;
            border: none !important;
            object-fit: contain;
            background: none !important;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4)) !important;
            animation: prizeGlow 2.5s ease-in-out infinite;
            display: block;
        }
        
        @keyframes prizeGlow {
            0% { 
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
            }
            50% { 
                filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.5));
            }
            100% { 
                filter: drop-shadow(0 0 16px rgba(255, 255, 255, 0.6));
            }
        }
        
        .prize-textbox {
            background: transparent !important;
            border: none !important;
            border-radius: 15px;
            padding: 5px 10px; /* ✅ ADJUSTED: Better padding for mobile */
            margin: 8px 0; /* ✅ INCREASED: More margin between text elements */
            color: #FFFFFF !important;
            font-family: 'Orbitron', monospace !important;
            font-weight: 600 !important;
            font-size: 14px !important; /* ✅ ADJUSTED: Good size for mobile */
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.4) !important;
            max-width: 100%;
            line-height: 1.4; /* ✅ IMPROVED: Better line height */
            word-wrap: break-word;
            text-align: center;
        }
        
        #prizeTitle {
            font-size: 16px !important; /* ✅ ADJUSTED: Good size for mobile */
            font-weight: 600 !important;
            margin: 12px 0 !important; /* ✅ INCREASED: More margin */
        }
        
        #prizeWorth {
            font-size: 18px !important; /* ✅ ADJUSTED: Good size for mobile */
            font-weight: 700 !important;
            margin: 15px 0 !important; /* ✅ INCREASED: More margin */
        }
        
        /* ✅ FIXED: Winner buttons with proper mobile sizing */
        .winner-buttons {
            display: flex;
            gap: 10px; /* ✅ INCREASED: More gap between buttons */
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px; /* ✅ INCREASED: More margin from content */
            width: 100%;
        }
        
        .golden-card-close, .return-home-winner {
            background: linear-gradient(145deg, #654321 0%, #5d4037 100%);
            color: #ffd700;
            border: none;
            padding: 12px 20px; /* ✅ INCREASED: Bigger buttons for mobile */
            border-radius: 12px;
            font-size: 10px !important; /* ✅ INCREASED: Bigger text */
            font-family: 'Orbitron', monospace !important;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            border: 3px solid #a0522d;
            min-width: 120px; /* ✅ ADDED: Minimum width for buttons */
        }
        
        .return-home-winner {
            background: linear-gradient(145deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        /* ✅ IMPROVED: Mobile Responsive with better sizing */
        @media (max-width: 768px) {
            .slot-machine-container {
                width: 350px;
                height: 520px;
                transform: scale(0.95);
            }
            
            .golden-card {
                width: 95vw !important; /* ✅ CHANGED: Use viewport width */
                max-width: 350px !important; /* ✅ ADDED: Max width constraint */
                height: auto !important;
                max-height: 85vh !important; /* ✅ ADJUSTED: Better max height for mobile */
                padding: 15px 10px 15px 10px !important; /* ✅ ADJUSTED: Better padding */
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
            }
            
            .eureka-header {
                font-size: 18px !important; /* ✅ ADJUSTED: Better mobile size */
                margin-bottom: 12px !important;
                line-height: 1.2 !important;
            }
            
            .prize-image {
                max-height: 120px !important; /* ✅ ADJUSTED: Smaller for mobile */
                margin: 12px auto !important;
            }
            
            .prize-textbox {
                font-size: 12px !important; /* ✅ ADJUSTED: Good readable size */
                padding: 4px 8px !important;
                margin: 6px 0 !important;
                line-height: 1.3 !important;
            }
            
            #prizeTitle {
                font-size: 14px !important; /* ✅ ADJUSTED: Good mobile size */
                margin: 10px 0 !important;
            }
            
            #prizeWorth {
                font-size: 16px !important; /* ✅ ADJUSTED: Good mobile size */
                margin: 12px 0 !important;
            }
            
            .winner-buttons {
                margin-top: 15px !important;
                gap: 8px !important;
            }
            
            .golden-card-close, .return-home-winner {
                padding: 10px 16px !important; /* ✅ ADJUSTED: Good mobile button size */
                font-size: 9px !important;
                min-width: 100px !important;
            }
            
            .reels-overlay {
                top: 260px;
            }
            
            .spin-button-container {
                bottom: 100px;
            }
            
            .status-overlay {
                bottom: 30px;
            }
            
            .email-popup-content {
                padding: 30px 20px;
            }
            
            .popup-buttons {
                flex-direction: column;
            }
            
            .popup-buttons button {
                min-width: auto;
                width: 100%;
            }
            
            /* ✅ ADDED: Better modal sizing for mobile */
            .modal-content {
                width: 95% !important;
                max-width: 400px !important;
                padding: 30px 20px !important;
                font-size: 16px !important; /* ✅ Even bigger text for mobile */
            }
            
            .order-again-btn {
                padding: 12px 25px !important;
                font-size: 14px !important; /* ✅ Bigger button text for mobile */
            }
        }
        
        /* ✅ ADDED: Extra small screen adjustments */
        @media (max-width: 480px) {
            .golden-card {
                max-height: 90vh !important;
                padding: 12px 8px 12px 8px !important;
            }
            
            .eureka-header {
                font-size: 16px !important;
            }
            
            .prize-textbox {
                font-size: 11px !important;
            }
            
            #prizeTitle {
                font-size: 13px !important;
            }
            
            #prizeWorth {
                font-size: 15px !important;
            }
        }
    </style>
</head>

<body>
    <!-- Email popup -->
    <div class="email-popup" id="emailPopup">
        <div class="email-popup-content">
            <h2>🎰 Welcome to PB DAYS ARCADE! 🎉</h2>
            <p>Enter your email to spin and win amazing dental prizes!</p>
            <input type="email" id="popupEmailInput" placeholder="Enter your email address" required>
            <div class="popup-buttons">
                <button onclick="submitEmailAndStart()">🎮 START PLAYING</button>
            </div>
        </div>
    </div>
    
    <!-- ✅ FIXED: Custom Modal without OK button for order used case -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div id="modalMessage">Message here</div>
            <button class="modal-close" id="modalCloseBtn" onclick="closeCustomModal()">OK</button>
            <div id="orderAgainContainer" style="margin-top: 15px; display: none;">
                <button class="order-again-btn" onclick="orderAgain()">ORDER AGAIN</button>
            </div>
        </div>
    </div>
    
    <button class="return-home" onclick="returnToHome()">← BACK TO PINKBLUE</button>
    <button class="audio-control" id="audioControl" onclick="toggleAudio()">🔊</button>
    
    <div class="slot-machine-container">
        <div class="slot-machine-bg">
            <div class="header-text">
                <h3>PB DAYS ARCADE - SPIN THE WHEEL</h3>
                <p>WIN AMAZING DENTAL PRIZES!</p>
            </div>
            
            <div class="reels-overlay">
                <div class="reel-window">
                    <div class="reel-strip" id="reel1"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-strip" id="reel2"></div>
                </div>
                <div class="reel-window">
                    <div class="reel-strip" id="reel3"></div>
                </div>
            </div>
            
            <div class="spin-button-container">
                <button class="spin-button" id="spinBtn" onclick="spin()">SPIN</button>
            </div>
            
            <div class="status-overlay">
                <div class="spins-left">
                    <span id="spinsLeft">0</span> SPINS AVAILABLE
                </div>
            </div>
        </div>
    </div>
    
    <!-- Winner card -->
    <div class="golden-card" id="goldenCard">
        <div class="eureka-header">🏆 EUREKA! 🏆</div>
        
        <img class="prize-image" id="prizeImage" src="" alt="Prize Image">
        
        <div class="prize-textbox" id="prizeTitle">
            YOU WON THIS AMAZING PRIZE!
        </div>
        
        <div class="prize-textbox" id="prizeDescription">
            Your prize will be sent once your order is delivered!
        </div>
        
        <div class="prize-textbox" id="prizeWorth">
            Worth ₹0
        </div>
        
        <div class="prize-textbox" style="font-style: italic;">
            🎉 Email notification sent! Check your inbox! 📧
        </div>
        
        <div class="winner-buttons">
            <button class="golden-card-close" id="closeCard" onclick="closeWinnerCard()">AWESOME!</button>
            <button class="return-home-winner" onclick="returnToHome()">← BACK TO PINKBLUE</button>
        </div>
    </div>

    <script>
        class AudioSystem {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.isMuted = false;
                this.musicStarted = false;
                this.init();
            }

            async init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.connect(this.audioContext.destination);
                    this.masterGain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    
                    this.createBackgroundMusic();
                    
                    console.log('🎵 Audio system initialized with working background music');
                } catch (error) {
                    console.log('Audio not supported:', error);
                }
            }

            createBackgroundMusic() {
                if (!this.audioContext || this.isMuted) return;

                const playArcadeLoop = () => {
                    if (this.isMuted || !this.audioContext) return;

                    const chords = [
                        [261.63, 329.63, 392.00], // C Major
                        [293.66, 369.99, 440.00], // D Major  
                        [220.00, 277.18, 329.63], // A Major
                        [246.94, 311.13, 369.99]  // B Major
                    ];

                    chords.forEach((chord, index) => {
                        setTimeout(() => {
                            if (this.isMuted || !this.audioContext) return;
                            
                            chord.forEach((freq) => {
                                const osc = this.audioContext.createOscillator();
                                const gain = this.audioContext.createGain();
                                
                                osc.connect(gain);
                                gain.connect(this.masterGain);
                                
                                osc.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                                osc.type = 'square';
                                
                                gain.gain.setValueAtTime(0, this.audioContext.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.02, this.audioContext.currentTime + 0.1);
                                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.8);
                                gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 1);
                                
                                osc.start();
                                osc.stop(this.audioContext.currentTime + 1);
                            });
                        }, index * 1000);
                    });

                    setTimeout(() => {
                        if (!this.isMuted) playArcadeLoop();
                    }, 4000);
                };

                document.addEventListener('click', () => {
                    if (!this.musicStarted && !this.isMuted) {
                        playArcadeLoop();
                        this.musicStarted = true;
                        console.log('🎵 Synthetic arcade background music started');
                    }
                }, { once: true });
            }

            playSpinSound() {
                if (!this.audioContext || this.isMuted) return;
                
                try {
                    const now = this.audioContext.currentTime;
                    
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.exponentialRampToValueAtTime(880, now + 0.4);
                    osc.frequency.exponentialRampToValueAtTime(220, now + 0.8);
                    osc.type = 'triangle';
                    
                    gain.gain.setValueAtTime(0.08, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
                    
                    osc.start(now);
                    osc.stop(now + 0.9);
                    
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => this.createSoftBell(), i * 180);
                    }
                } catch (error) {
                    console.log('Spin sound error:', error);
                }
            }

            createSoftBell() {
                if (!this.audioContext || this.isMuted) return;
                
                const now = this.audioContext.currentTime;
                const bellOsc = this.audioContext.createOscillator();
                const bellGain = this.audioContext.createGain();
                
                bellOsc.connect(bellGain);
                bellGain.connect(this.masterGain);
                
                const bellFreqs = [523.25, 587.33, 659.25, 783.99, 880.00];
                const freq = bellFreqs[Math.floor(Math.random() * bellFreqs.length)];
                
                bellOsc.frequency.setValueAtTime(freq, now);
                bellOsc.type = 'sine';
                
                bellGain.gain.setValueAtTime(0.015, now);
                bellGain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                
                bellOsc.start(now);
                bellOsc.stop(now + 0.4);
            }

            playWinSound() {
                if (!this.audioContext || this.isMuted) return;
                
                try {
                    const now = this.audioContext.currentTime;
                    const victoryNotes = [523.25, 659.25, 783.99, 1046.50];
                    
                    victoryNotes.forEach((freq, index) => {
                        setTimeout(() => {
                            const osc = this.audioContext.createOscillator();
                            const gain = this.audioContext.createGain();
                            
                            osc.connect(gain);
                            gain.connect(this.masterGain);
                            
                            osc.frequency.setValueAtTime(freq, this.audioContext.currentTime);
                            osc.type = 'sine';
                            
                            gain.gain.setValueAtTime(0.15, this.audioContext.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.8);
                            
                            osc.start();
                            osc.stop(this.audioContext.currentTime + 0.8);
                        }, index * 200);
                    });
                } catch (error) {
                    console.log('Win sound error:', error);
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.audioContext) {
                    this.masterGain.gain.setValueAtTime(this.isMuted ? 0 : 0.3, this.audioContext.currentTime);
                }
                return this.isMuted;
            }
        }

        const audioSystem = new AudioSystem();

        // Global variables with race condition protection
        let userSession = null;
        let spinning = false;
        let userEmail = '';
        let usedOrders = new Set(); // Client-side tracking to prevent race conditions
        
        const symbols = [
            { name: '7', image: 'https://email-editor-resources.s3.amazonaws.com/images/82618240/stw-sep25/7.png' },
            { name: 'Star', image: 'https://email-editor-resources.s3.amazonaws.com/images/82618240/stw-sep25/Star.png' },
            { name: 'Grape', image: 'https://email-editor-resources.s3.amazonaws.com/images/82618240/stw-sep25/Grape.png' }
        ];

        function initializeReels() {
            for (let i = 1; i <= 3; i++) {
                const strip = document.getElementById(`reel${i}`);
                strip.innerHTML = '';
                
                for (let j = 0; j < 6; j++) {
                    symbols.forEach(symbol => {
                        const symbolDiv = document.createElement('div');
                        symbolDiv.className = 'symbol';
                        symbolDiv.dataset.symbol = symbol.name;
                        
                        const img = document.createElement('img');
                        img.src = symbol.image;
                        img.alt = symbol.name;
                        img.loading = 'eager';
                        
                        symbolDiv.appendChild(img);
                        strip.appendChild(symbolDiv);
                    });
                }
            }
        }

        // ✅ FIXED: Email validation with proper error handling
        async function submitEmailAndStart() {
            const emailInput = document.getElementById('popupEmailInput');
            const email = emailInput.value.trim();
            const startButton = document.querySelector('.email-popup button');
            
            if (!email || !email.includes('@')) {
                showCustomModal('Please enter a valid email address!');
                emailInput.focus();
                return;
            }

            try {
                userEmail = email;
                localStorage.setItem('arcadeEmail', email);
                
                const originalText = startButton.textContent;
                startButton.textContent = 'CHECKING...';
                startButton.disabled = true;
                
                const customerData = await fetchCustomerData(email);
                
                startButton.textContent = originalText;
                startButton.disabled = false;
                
                if (customerData && customerData.orderData) {
                    document.getElementById('emailPopup').classList.add('hidden');
                    initializeGameForUser(email, customerData);
                } else {
                    // ✅ FIXED: Show proper error message for invalid orders
                    showCustomModal('No eligible orders found from the last 2 days. Please place a new order and try again!');
                    // ✅ FIXED: Don't hide email popup if validation fails
                    startButton.textContent = originalText;
                    startButton.disabled = false;
                }
            } catch (error) {
                console.error('Email submission error:', error);
                // ✅ FIXED: Show proper error message and reset button
                showCustomModal('Unable to check orders. Please check your internet connection and try again.');
                startButton.textContent = originalText;
                startButton.disabled = false;
            }
        }

        function checkIfOverrideUser(email) {
            const normalizedEmail = email.toLowerCase().trim();
            return normalizedEmail.includes('testoverridemaaz') || 
                   normalizedEmail.includes('testoverridevalli');
        }

        async function fetchCustomerData(email) {
            try {
                const response = await fetch('/.netlify/functions/get-customer-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    return {
                        orderData: data.orderData,
                        orderValue: parseFloat(data.orderData?.grand_total || 0),
                        email: email
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error fetching customer data:', error);
                return null;
            }
        }

        // Order usage check with race condition protection
        async function checkOrderUsage(email, orderNumber) {
            try {
                console.log('🔍 Checking order usage for:', orderNumber, 'by email:', email);
                
                const normalizedOrderNumber = orderNumber.replace(/^0+/, '') || '0';
                
                // Race condition fix: Check client-side first
                if (usedOrders.has(normalizedOrderNumber)) {
                    console.log('❌ Order blocked by client-side tracking:', normalizedOrderNumber);
                    return { 
                        success: true, 
                        canSpin: false, 
                        reason: 'Order already used (client-side check)',
                        clientSideBlocked: true
                    };
                }
                
                const response = await fetch('/.netlify/functions/check-order-usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'checkOrderIdUsage',
                        email: email,
                        orderNumber: orderNumber
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📋 Order usage check result:', result);
                
                return result;
            } catch (error) {
                console.error('❌ Order usage check error:', error);
                return { success: false, error: 'Failed to check order usage' };
            }
        }

        function initializeGameForUser(email, customerData) {
            if (checkIfOverrideUser(email)) {
                document.getElementById('spinsLeft').textContent = '∞';
            } else {
                document.getElementById('spinsLeft').textContent = '1';
            }
        }

        // Spin function with proper race condition prevention
        async function spin() {
            if (spinning) {
                console.log('⚠️ Spin already in progress');
                return;
            }
            
            const email = userEmail || localStorage.getItem('arcadeEmail');
            const spinBtn = document.getElementById('spinBtn');
            
            if (!email || !email.includes('@')) {
                showCustomModal('Please refresh the page and enter a valid email address!');
                return;
            }

            spinning = true;
            spinBtn.disabled = true;
            spinBtn.classList.add('spinning-state');
            spinBtn.textContent = 'CHECKING...';

            try {
                const isOverrideUser = checkIfOverrideUser(email);
                let customerData = null;

                if (!isOverrideUser) {
                    customerData = await fetchCustomerData(email);
                    
                    if (!customerData) {
                        showCustomModal('No valid order found for this email in the last 2 days.');
                        resetSpinButton();
                        return;
                    }

                    const orderNumber = customerData.orderData?.increment_id;

                    if (!orderNumber) {
                        showCustomModal('No valid order number found.');
                        resetSpinButton();
                        return;
                    }

                    console.log('🔍 Checking order usage before spin...');
                    const orderUsageCheck = await checkOrderUsage(email, orderNumber);
                    
                    if (orderUsageCheck && !orderUsageCheck.canSpin) {
                        console.log('❌ Order usage check blocked spin');
                        showOrderAlreadyUsedModal();
                        spinBtn.style.display = 'none';
                        spinning = false;
                        return;
                    }

                    // Race condition fix: Mark order as used immediately (client-side)
                    const normalizedOrderNumber = orderNumber.replace(/^0+/, '') || '0';
                    usedOrders.add(normalizedOrderNumber);
                    console.log('✅ Order marked as used client-side:', normalizedOrderNumber);

                } else {
                    customerData = {
                        orderData: { 
                            increment_id: 'OVERRIDE_ORDER_' + Date.now(),
                            grand_total: '15000.00',
                            customer_firstname: 'Override',
                            customer_lastname: 'User'
                        },
                        orderValue: 15000,
                        email: email
                    };
                }

                userSession = customerData;
                spinBtn.textContent = 'SPINNING...';
                
                audioSystem.playSpinSound();

                const spinDurations = [1800, 2200, 2600];
                
                for (let i = 1; i <= 3; i++) {
                    const strip = document.getElementById(`reel${i}`);
                    if (strip) {
                        strip.classList.add('spinning');
                    }
                }

                const reelPromises = spinDurations.map((duration, index) => {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const strip = document.getElementById(`reel${index + 1}`);
                            if (strip) {
                                strip.classList.remove('spinning');
                                
                                const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                                const symbolIndex = symbols.findIndex(s => s.name === randomSymbol.name);
                                const translateDistance = symbolIndex * 75;
                                strip.style.transform = `translateY(-${translateDistance}px)`;
                            }
                            resolve();
                        }, duration);
                    });
                });

                await Promise.all(reelPromises);
                spinBtn.textContent = 'PROCESSING...';
                await processPrize(email, customerData);

            } catch (error) {
                console.error('Spin error:', error);
                showCustomModal('Something went wrong. Please try again.');
                resetSpinButton();
            } finally {
                spinning = false;
            }
        }

        // ✅ FIXED: Show order already used modal without OK button
        function showOrderAlreadyUsedModal() {
            const modal = document.getElementById('customModal');
            const messageDiv = document.getElementById('modalMessage');
            const orderAgainContainer = document.getElementById('orderAgainContainer');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            
            messageDiv.textContent = 'You have already spun with this order. Please place a new order to spin again!';
            orderAgainContainer.style.display = 'block';
            modalCloseBtn.style.display = 'none'; // ✅ HIDE OK BUTTON
            modal.style.display = 'flex';
        }

        function orderAgain() {
            window.location.href = 'https://pinkblue.in';
        }

        async function processPrize(email, customerData) {
            const spinBtn = document.getElementById('spinBtn');
            
            try {
                const response = await fetch('/.netlify/functions/allocate-prize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        orderValue: customerData.orderValue,
                        orderData: customerData.orderData,
                        orderNumber: customerData.orderData?.increment_id,
                        sessionId: Date.now().toString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    spinBtn.textContent = 'PRIZE WON!';
                    spinBtn.classList.add('prize-won');
                    
                    showWinnerCard(data.prize);
                    audioSystem.playWinSound();
                    
                    setTimeout(() => {
                        if (checkIfOverrideUser(email)) {
                            resetSpinButton();
                            spinBtn.textContent = 'SPIN AGAIN';
                        } else {
                            spinBtn.textContent = 'ORDER USED';
                            spinBtn.disabled = true;
                            spinBtn.style.opacity = '0.5';
                        }
                    }, 3000);
                    
                } else {
                    showCustomModal(data.error || 'Unable to allocate prize. Please try again.');
                    resetSpinButton();
                }
            } catch (error) {
                console.error('Prize allocation error:', error);
                showCustomModal('Something went wrong. Please contact support.');
                resetSpinButton();
            }
        }

        function showWinnerCard(prize) {
            const card = document.getElementById('goldenCard');
            const titleElement = document.getElementById('prizeTitle');
            const descElement = document.getElementById('prizeDescription');
            const worthElement = document.getElementById('prizeWorth');
            const imageElement = document.getElementById('prizeImage');
            
            const cleanPrizeName = cleanProductName(prize.name);
            titleElement.textContent = `YOU WON: ${cleanPrizeName}`;
            
            if (prize.name && prize.name.toUpperCase().includes('CASHBACK')) {
                descElement.textContent = 'Your cashback will be credited once your order is delivered!';
                imageElement.style.display = 'none';
            } else {
                descElement.textContent = 'This product will be sent once your order is delivered!';
                if (prize.image) {
                    imageElement.src = prize.image;
                    imageElement.style.display = 'block';
                } else {
                    imageElement.style.display = 'none';
                }
            }
            
            worthElement.textContent = `Worth ₹${prize.value || '0'}`;
            card.classList.add('show');
        }

        function cleanProductName(prizeName) {
            if (!prizeName) return 'Mystery Prize';
            
            let cleanName = prizeName
                .replace(/^[A-Z0-9_]+\s*[-_]\s*/i, '')
                .replace(/^[A-Z]{2,}\s+/i, '')
                .replace(/\s*[-_]\s*[A-Z0-9_]+$/i, '')
                .trim();
            
            if (!cleanName || cleanName.length < 3) {
                return prizeName;
            }
            
            return cleanName;
        }

        function resetSpinButton() {
            const spinBtn = document.getElementById('spinBtn');
            spinning = false;
            spinBtn.disabled = false;
            spinBtn.textContent = 'SPIN';
            spinBtn.style.opacity = '1';
            spinBtn.style.display = 'block';
            spinBtn.style.background = 'linear-gradient(145deg, #ffd700 0%, #ffed4e 30%, #b8860b 100%)';
            spinBtn.classList.remove('spinning-state', 'prize-won');
        }

        function closeWinnerCard() {
            document.getElementById('goldenCard').classList.remove('show');
        }

        // ✅ FIXED: Show custom modal with proper OK button visibility
        function showCustomModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('orderAgainContainer').style.display = 'none';
            document.getElementById('modalCloseBtn').style.display = 'block'; // ✅ SHOW OK BUTTON for regular modals
            document.getElementById('customModal').style.display = 'flex';
        }

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            document.getElementById('orderAgainContainer').style.display = 'none';
        }

        function returnToHome() {
            window.location.href = 'https://pinkblue.in';
        }

        function toggleAudio() {
            const button = document.getElementById('audioControl');
            const isMuted = audioSystem.toggleMute();
            button.textContent = isMuted ? '🔇' : '🔊';
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎰 FINAL PB DAYS ARCADE - All issues fixed!');
            
            initializeReels();
            
            const storedEmail = localStorage.getItem('arcadeEmail');
            if (storedEmail) {
                userEmail = storedEmail;
                document.getElementById('emailPopup').classList.add('hidden');
            } else {
                document.getElementById('popupEmailInput').focus();
            }

            document.body.addEventListener('click', () => {
                if (audioSystem.audioContext && audioSystem.audioContext.state === 'suspended') {
                    audioSystem.audioContext.resume();
                }
            }, { once: false });
        });
    </script>
</body>
</html>
